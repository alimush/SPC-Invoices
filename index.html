<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>SPC Quotation Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <link rel="icon" href="Iconin.png" type="image/png">
  <link rel="apple-touch-icon" href="Iconin.png">
</head>
<body class="font-sans bg-gray-100 p-8">

  <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg mb-8">
    <h1 class="text-2xl font-bold mb-6 text-blue-900">SPC Quotation Generator</h1>

    <div class="flex flex-wrap gap-4 mb-6">
      <div class="flex-1 min-w-[200px]">
        <label class="block text-blue-900 font-medium mb-1">Quotation Date</label>
        <input id="dateInput" type="date" class="border rounded p-2 w-full">
      </div>
      <div class="flex-1 min-w-[200px]">
        <label class="block text-blue-900 font-medium mb-1">Company</label>
        <input list="companies" id="companyInput" class="border rounded p-2 w-full" placeholder="اختر أو اكتب الشركة" />
        <datalist id="companies">
          <option value="Al-Rida"></option>
          <option value="Al-Mezan"></option>
          <option value="Al-Ghadeer"></option>
          <option value="Al-Riyad"></option>
          <option value="Anwar Al Emara"></option>
          <option value="Smart House"></option>
        </datalist>
      </div>
    </div>

    <div id="currencyDiv" class="flex flex-wrap gap-4 mb-6 hidden">
      <div class="flex-1 min-w-[200px]">
        <label class="block text-blue-900 font-medium mb-1">Currency</label>
        <select id="currencyInput" class="border rounded p-2 w-full">
          <option value="IQD">IQD</option>
          <option value="USD">USD</option>
        </select>
      </div>
    </div>

    <div id="itemInputs" class="flex flex-wrap gap-4 mb-6 hidden">
      <div class="flex-1 min-w-[150px]">
        <label class="block text-blue-900 font-medium mb-1">Description</label>
        <textarea id="descInput" placeholder="Item description" rows="2" class="border rounded p-2 w-full resize-y"></textarea>
      </div>
      <div class="flex-1 min-w-[150px]">
        <label class="block text-blue-900 font-medium mb-1">Quantity</label>
        <input id="qtyInput" type="number" class="border rounded p-2 w-full">
      </div>
      <div class="flex-1 min-w-[150px]">
        <label class="block text-blue-900 font-medium mb-1">Unit Price</label>
        <input id="priceInput" type="number" class="border rounded p-2 w-full">
      </div>
    </div>

    <div class="flex flex-wrap gap-2 mb-4 items-center">
      <button id="newInvoiceBtn" onclick="newInvoice()" class="bg-blue-700 hover:bg-blue-800 text-white font-semibold px-4 py-2 rounded">إنشاء فاتورة</button>
      <button id="addRowBtn" onclick="addRow()" class="bg-blue-700 hover:bg-blue-800 text-white font-semibold px-4 py-2 rounded hidden">إضافة صف</button>
      <input id="fileNameInput" type="text" placeholder="اسم الملف" class="border rounded p-2 hidden" style="min-width: 150px;">
      <button id="pdfBtn" onclick="generatePDF()" class="bg-green-700 hover:bg-green-800 text-white font-semibold px-4 py-2 rounded hidden">توليد PDF</button>

      <!-- حفظ/تحميل JSON -->
      <button id="saveJsonBtn"
              onclick="downloadInvoiceJSON()"
              class="bg-amber-600 hover:bg-amber-700 text-white font-semibold px-4 py-2 rounded hidden no-pdf">
        حفظ كـ JSON
      </button>

      <label class="bg-purple-700 hover:bg-purple-800 text-white font-semibold px-4 py-2 rounded cursor-pointer no-pdf">
        تحميل فاتورة قديمة (JSON)
        <input id="loadJsonInput" type="file" accept=".json" class="hidden"
               onchange="loadInvoiceFromJSON(this.files[0])">
      </label>

     
    </div>

    <div id="statusDiv" class="flex flex-wrap gap-4 mb-6 hidden">
      <div class="flex-1 min-w-[200px]">
        <label class="block text-blue-900 font-medium mb-1">Invoice Status</label>
        <select id="statusInput" class="border rounded p-2 w-full">
          <option value="">-- none --</option>
          <option value="Unpaid">Unpaid</option>
          <option value="Paid">Paid</option>
        </select>
      </div>
    </div>
  </div>

  <div id="invoice" class="bg-white p-6 max-w-[800px] mx-auto"></div>

  <div id="trimPagesBtn" class="fixed left-2 top-1/2 transform -translate-y-1/2 flex flex-col gap-2 ">
    <button onclick="adjustMargin(-40)" class="bg-blue-700 hover:bg-blue-800 text-white font-bold text-xl px-3 py-2 rounded hidden" id="upBtn">⬆</button>
    <button onclick="adjustMargin(40)" class="bg-blue-700 hover:bg-blue-800 text-white font-bold text-xl px-3 py-2 rounded hidden" id="downBtn">⬇</button>
  </div>

  <script>
    // ====== الحالة العامة ======
    let anchorIndex = null;   // أول صف انطلقت منه للتحديد بالرّينج (Shift)
let focusedIndex = 0;     // الصف الحالي المتركّز عليه للتنقّل بالأسهم
    let editRowIndex = null;         // الصف الذي يتم تعديله الآن (أو null)
    let selectedRowIndexes = [];     // اختيار متعدد
    let rowsPerPageCurrent = 5;      // تقسيم الصفحات الحالي
    let total = 0;
    let rowsData = [];
    let invoiceNo = '';
    let footerMargin = 21;

    const termsConditionText = `
      <strong>Terms and Conditions:</strong><br>
      - Payment is due within 15 days of the invoice date.<br>
      - Devices and services remain the property of SPC until full payment is received.<br>
      - All disputes must be reported within 7 days of invoice issue.<br>
      - Warranty terms apply as per the product or service agreement.
    `;

    // ====== أدوات مساعدة ======
    function generateInvoiceNo() {
      const now = new Date();
      return `PRC-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
    }

    function formatNumber(num) {
      return Number.isInteger(num)
        ? num.toLocaleString('en')
        : num.toLocaleString('en', { maximumFractionDigits: 2 });
    }

    function recomputeTotal() {
      total = rowsData.reduce((sum, r) => {
        const v = (r && typeof r.amountNum === 'number' && Number.isFinite(r.amountNum)) ? r.amountNum : 0;
        return sum + v;
      }, 0);
    }

    // ====== إنشاء فاتورة ======
    function newInvoice() {
      const dateInput = document.getElementById('dateInput').value;
      const companyInput = document.getElementById('companyInput').value;
      if (!dateInput || !companyInput) { alert("يرجى إدخال التاريخ واختيار الشركة"); return; }

      if (!invoiceNo) invoiceNo = generateInvoiceNo();
      rowsData = [];
      total = 0;
      editRowIndex = null;
      selectedRowIndexes = [];

      // إظهار أدوات الإدخال والأزرار
      document.getElementById('currencyDiv') .classList.remove('hidden');
      document.getElementById('statusDiv')   .classList.remove('hidden');
      document.getElementById('itemInputs')  .classList.remove('hidden');
      document.getElementById('addRowBtn')   .classList.remove('hidden');
      document.getElementById('pdfBtn')      .classList.remove('hidden');
      document.getElementById('fileNameInput').classList.remove('hidden');
      document.getElementById('trimPagesBtn').classList.remove('hidden');
      document.getElementById('upBtn')       .classList.remove('hidden');
      document.getElementById('downBtn')     .classList.remove('hidden');
      const saveBtn = document.getElementById('saveJsonBtn');
      if (saveBtn) saveBtn.classList.remove('hidden');

      buildPaginatedInvoice(rowsData.length);
    }

    // ====== صفوف (إضافة/تحديد/حذف) ======
    function addRow() {
      const desc = document.getElementById('descInput').value.trim();
      const qtyRaw = document.getElementById('qtyInput').value;
      const priceRaw = document.getElementById('priceInput').value;
      const currency = document.getElementById('currencyInput').value;

      const qty = parseFloat(qtyRaw);
      const price = priceRaw === '' ? null : parseFloat(priceRaw); // السعر ممكن يكون فارغ

      if (!desc || isNaN(qty) || qty <= 0) {
        alert("الرجاء إدخال وصف صحيح وكمية أكبر من 0. السعر اختياري.");
        return;
      }

      const descFormatted = desc.replace(/\n/g, '<br>');
      const amountNum = (price === null || isNaN(price)) ? 0 : qty * price;

      rowsData.push({
        desc: descFormatted,
        qty,
        priceNum: (price === null || isNaN(price)) ? null : price,
        amountNum,
        currency,
        price: (price === null || isNaN(price)) ? '' : `${formatNumber(price)} ${currency}`,
        amount: (price === null || isNaN(price)) ? '' : `${formatNumber(amountNum)} ${currency}`
      });

      recomputeTotal();

      document.getElementById('descInput').value = '';
      document.getElementById('qtyInput').value  = '';
      document.getElementById('priceInput').value= '';

      buildPaginatedInvoice(rowsData.length);
    }

    function selectRow(globalIndex, evt) {
  // لو داخل وضع التعديل، لا تغيّر التحديد
  if (editRowIndex !== null) return;

  const i = selectedRowIndexes.indexOf(globalIndex);

  // إذا الصف هو الوحيد المختار ودوّست عليه مرة ثانية → ألغِ التحديد كله
  if (selectedRowIndexes.length === 1 && selectedRowIndexes[0] === globalIndex) {
    selectedRowIndexes = [];
    anchorIndex = null;
    buildPaginatedInvoice(rowsPerPageCurrent);
    return;
  }

  // toggle عادي: إذا كان مختار شيله، إذا لا خليه هو الوحيد
  if (i > -1) {
    selectedRowIndexes.splice(i, 1);
  } else {
    selectedRowIndexes = [globalIndex];
    anchorIndex = globalIndex;
  }

  focusedIndex = globalIndex;
  buildPaginatedInvoice(rowsPerPageCurrent);
}


    function deleteSelectedRow() {
      if (!selectedRowIndexes || selectedRowIndexes.length === 0) return;
      selectedRowIndexes.sort((a, b) => b - a);
      selectedRowIndexes.forEach(idx => {
        if (idx >= 0 && idx < rowsData.length) rowsData.splice(idx, 1);
      });
      selectedRowIndexes = [];
      recomputeTotal();
      buildPaginatedInvoice(rowsPerPageCurrent);
    }

    function startEditRow() {
      if (selectedRowIndexes.length !== 1) return;
      editRowIndex = selectedRowIndexes[0];
      buildPaginatedInvoice(rowsPerPageCurrent);
      setTimeout(() => document.getElementById('editDesc')?.focus(), 0);
    }

    function saveEditRow(idx) {
      const descEl  = document.getElementById('editDesc');
      const qtyEl   = document.getElementById('editQty');
      const priceEl = document.getElementById('editPrice');
      if (!descEl || !qtyEl || !priceEl) { cancelEditRow(); return; }

      const desc  = (descEl.value || '').trim().replace(/\n/g, '<br>');
      const qty   = parseFloat(qtyEl.value);
      const price = priceEl.value === '' ? null : parseFloat(priceEl.value);

      if (!desc || isNaN(qty) || qty <= 0) {
        alert('الوصف مطلوب والكمية يجب أن تكون أكبر من 0. السعر اختياري.');
        return;
      }

      const currency = rowsData[idx]?.currency || document.getElementById('currencyInput').value || '';
      const amountNum = (price === null || isNaN(price)) ? 0 : (qty * price);

      rowsData[idx] = {
        ...rowsData[idx],
        desc,
        qty,
        priceNum: (price === null || isNaN(price)) ? null : price,
        amountNum,
        currency,
        price:  (price === null || isNaN(price)) ? '' : `${formatNumber(price)} ${currency}`,
        amount: (price === null || isNaN(price)) ? '' : `${formatNumber(amountNum)} ${currency}`
      };

      recomputeTotal();
      editRowIndex = null;
      selectedRowIndexes = [idx];
      buildPaginatedInvoice(rowsPerPageCurrent);
    }

    function cancelEditRow() {
      editRowIndex = null;
      buildPaginatedInvoice(rowsPerPageCurrent);
    }

    // ====== بناء الصفحات ======
    function splitChunks(array, size) {
      const chunks = [];
      for (let i = 0; i < array.length; i += size) {
        chunks.push(array.slice(i, i + size));
      }
      return chunks;
    }

    function buildPaginatedInvoice(customRowsPerPage = 5) {
      rowsPerPageCurrent = customRowsPerPage;

      const company = document.getElementById('companyInput').value;
      const date    = document.getElementById('dateInput').value;
      const invoiceContainer = document.getElementById('invoice');
      invoiceContainer.innerHTML = '';

      const chunks = splitChunks(rowsData, customRowsPerPage);

      chunks.forEach((chunk, index) => {
        const isLastChunk = index === chunks.length - 1;
        const pageDiv = document.createElement('div');
        pageDiv.className = 'relative mb-12';

        // Header
        let headerHTML = '';
        if (index === 0) {
          const statusInput = document.getElementById('statusInput')?.value || '';
          let statusHTML = '';
          if (statusInput) {
            const statusColor = statusInput === "Paid" ? "text-green-600 font-bold" : "text-red-600 font-bold";
            statusHTML = `
              <div class="text-base mb-2">
                <strong>Status:</strong>
                <span class="${statusColor}">${statusInput}</span>
              </div>
            `;
          }
          headerHTML = `
            <div class="flex justify-between items-start mb-4 ">
              <div class="flex flex-col">
                <img src="SPC 03.png" alt="SPC Logo" style="width: 200px;" class="mb-1">
                <div class="text-sm">SOLUTION PORTAL COMPANY</div>
              </div>
              <div class="text-right italic text-sm">
                SOLUTION PORTAL COMPANY <br>
                YARMOK - 612 - <br>
                BAGHDAD IRAQ
              </div>
            </div>
            <div class="mt-6">
              <div class="text-base mb-2"><strong>Invoice No:</strong> ${invoiceNo}</div>
              <div class="text-base mb-2"><strong>Company:</strong> ${company}</div>
              <div class="text-base mb-2"><strong>Invoice Date:</strong> ${date}</div>
              ${statusHTML}
            </div>
          `;
        }

        // Table
        let tableHTML = `
          <table class="w-full table-fixed border border-black border-collapse mt-8">
            <thead>
              <tr class="bg-gray-300">
                <th class="border border-black p-2">DESCRIPTION</th>
                <th class="border border-black p-2 w-12 text-center">QTY</th>
                <th class="border border-black w-36 p-2">UNIT PRICE</th>
                <th class="border border-black w-36 p-2">AMOUNT</th>
              </tr>
            </thead>
            <tbody>
        `;

        chunk.forEach((row, rowIdx) => {
          const globalIndex = index * customRowsPerPage + rowIdx;
          const isSelected = selectedRowIndexes.includes(globalIndex);
          const selectedCls = isSelected ? 'ring-2 ring-blue-500 bg-yellow-50' : '';

          if (globalIndex === editRowIndex) {
            tableHTML += `
              <tr class="bg-yellow-50" onclick="event.stopPropagation()">
                <!-- DESCRIPTION -->
                <td class="border border-black p-1">
                  <input id="editDesc" type="text"
                         class="w-full h-8 rounded border border-gray-300 px-2 text-xs focus:outline-none focus:ring-1 focus:ring-amber-500 focus:border-amber-500"
                         placeholder="Description"
                         value="${(row.desc || '').replaceAll('<br>', ' ')}">
                </td>

                <!-- QTY -->
                <td class="border border-black p-1 text-center">
                  <input id="editQty" type="number"
                         class="w-16 h-8 rounded border border-gray-300 px-2 text-xs text-center focus:outline-none focus:ring-1 focus:ring-amber-500 focus:border-amber-500"
                         placeholder="0"
                         value="${row.qty}">
                </td>

                <!-- UNIT PRICE -->
                <td class="border border-black p-1">
                  <input id="editPrice" type="number"
                         class="w-24 h-8 rounded border border-gray-300 px-2 text-xs focus:outline-none focus:ring-1 focus:ring-amber-500 focus:border-amber-500"
                         placeholder="—"
                         value="${(typeof row.priceNum === 'number') ? row.priceNum : ''}">
                </td>

                <!-- AMOUNT + actions -->
                <td class="border border-black p-1">
                  <div class="flex items-center gap-2">
                    <span class="text-[11px] text-gray-500">auto</span>
                    <button onclick="event.stopPropagation(); saveEditRow(${globalIndex})"
                            class="no-pdf inline-flex items-center justify-center h-7 px-2 rounded bg-green-600 text-white text-[11px] hover:bg-green-700">
                      Save
                    </button>
                    <button onclick="event.stopPropagation(); cancelEditRow()"
                            class="no-pdf inline-flex items-center justify-center h-7 px-2 rounded bg-gray-500 text-white text-[11px] hover:bg-gray-600">
                      Cancel
                    </button>
                  </div>
                </td>
              </tr>
            `;
          } else {
            tableHTML += `
              <tr class="bg-gray-100 ${selectedCls} cursor-pointer"
    onclick="selectRow(${globalIndex}, event)">


                <td class="border border-black p-2 break-words whitespace-normal w-full"><div>${row.desc}</div></td>
                <td class="border border-black p-2 text-center">${row.qty}</td>
                <td class="border border-black p-2">${row.price || ''}</td>
                <td class="border border-black p-2">${row.amount || ''}</td>
              </tr>
            `;
          }
        });

        tableHTML += '</tbody>';

        if (isLastChunk) {
          const currencyFallback = document.getElementById('currencyInput')?.value || '';
          const firstWithCurrency = rowsData.find(r => r && r.currency);
          const totalCurrency = firstWithCurrency ? firstWithCurrency.currency : currencyFallback;

          tableHTML += `
            <tfoot>
              <tr class="bg-gray-700 text-white font-bold">
                <td class="border border-black p-2 text-left" colspan="3">Total</td>
                <td class="border border-black p-2">${formatNumber(total)} ${totalCurrency}</td>
              </tr>
            </tfoot>
          `;
        }

        tableHTML += '</table>';

        // Footer
        let spacer = `<div style="height:${footerMargin}px;"></div>`;
        let footerHTML = '';
        if (isLastChunk) {
          footerHTML = `
            ${spacer}
            <div class="text-sm text-gray-700 mt-32">
              ${termsConditionText}
            </div>
            <div class="flex justify-between text-xs text-gray-500 mt-52">
              <span>info@spc-it.com.iq</span>
              <span>www.spc-it.com.iq</span>
              <span>+964 7849322346</span>
            </div>
          `;
        }

        pageDiv.innerHTML = headerHTML + tableHTML + footerHTML;
        invoiceContainer.appendChild(pageDiv);
      });
    }

    // ====== حواف الفوتر ======
    function adjustMargin(change) {
      footerMargin = Math.max(0, footerMargin + change);
      buildPaginatedInvoice(rowsPerPageCurrent);
    }

    // ====== PDF ======
    function generatePDF() {
      const element = document.getElementById('invoice');
      let fileName = document.getElementById('fileNameInput').value.trim();
      if (!fileName) {
        alert("يرجى إدخال اسم الملف قبل توليد الـ PDF");
        return;
      }
      html2pdf().set({
        margin: 10,
        filename: `${fileName}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2,
          scrollY: 0,
          useCORS: true,
          ignoreElements: (el) => el.classList && el.classList.contains('no-pdf')
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
      }).from(element).save();
    }

    // ====== حفظ/تحميل JSON ======
    function getInvoiceState() {
      return {
        invoiceNo,
        date: document.getElementById('dateInput').value,
        company: document.getElementById('companyInput').value,
        currency: document.getElementById('currencyInput').value,
        status: document.getElementById('statusInput')?.value || '',
        footerMargin,
        rowsData,
        total
      };
    }

    function setInvoiceState(state) {
      invoiceNo = state.invoiceNo || invoiceNo || generateInvoiceNo();
      document.getElementById('dateInput').value    = state.date || '';
      document.getElementById('companyInput').value = state.company || '';
      document.getElementById('currencyInput').value= state.currency || 'IQD';
      const si = document.getElementById('statusInput');
      if (si) si.value = state.status || '';
      footerMargin = typeof state.footerMargin === 'number' ? state.footerMargin : footerMargin;

      rowsData = Array.isArray(state.rowsData) ? state.rowsData : [];
      recomputeTotal();

      // إظهار أدوات التعديل
      document.getElementById('currencyDiv').classList.remove('hidden');
      document.getElementById('statusDiv').classList.remove('hidden');
      document.getElementById('itemInputs').classList.remove('hidden');
      document.getElementById('addRowBtn').classList.remove('hidden');
      document.getElementById('pdfBtn').classList.remove('hidden');
      document.getElementById('fileNameInput').classList.remove('hidden');
      document.getElementById('trimPagesBtn').classList.remove('hidden');
      document.getElementById('upBtn').classList.remove('hidden');
      document.getElementById('downBtn').classList.remove('hidden');
      const saveBtn = document.getElementById('saveJsonBtn');
      if (saveBtn) saveBtn.classList.remove('hidden');

      buildPaginatedInvoice(rowsData.length || 5);
    }

    function downloadInvoiceJSON() {
      const state = getInvoiceState();
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const safeNo = state.invoiceNo ? state.invoiceNo.replace(/[^A-Za-z0-9-_]/g, '_') : 'invoice';
      a.download = `${safeNo}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      try { localStorage.setItem(`invoice:${state.invoiceNo}`, JSON.stringify(state)); } catch {}
    }

    function loadInvoiceFromJSON(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const state = JSON.parse(e.target.result);

          // تصحيح سريع لملفات قديمة
          const fixedRows = Array.isArray(state.rowsData) ? state.rowsData.map(r => {
            const qty = typeof r.qty === 'number' ? r.qty : parseFloat(r.qty) || 0;

            let priceNum = null;
            if (typeof r.priceNum === 'number') priceNum = r.priceNum;
            else if (typeof r.price === 'string') {
              const m = r.price.match(/[0-9.]+/);
              priceNum = m ? parseFloat(m[0]) : null;
            }

            let amountNum = 0;
            if (typeof r.amountNum === 'number') amountNum = r.amountNum;
            else if (Number.isFinite(qty) && Number.isFinite(priceNum || 0)) amountNum = qty * (priceNum || 0);

            const currencyGuess = r.currency || (typeof r.price === 'string'
              ? (r.price.replace(/[0-9.,\s]/g, '').trim() || '')
              : '');

            const currency = currencyGuess || state.currency || document.getElementById('currencyInput').value || 'IQD';

            return {
              desc: r.desc || '',
              qty,
              priceNum: Number.isFinite(priceNum) ? priceNum : null,
              amountNum: Number.isFinite(amountNum) ? amountNum : 0,
              currency,
              price:  (Number.isFinite(priceNum)  ? `${formatNumber(priceNum)} ${currency}` : ''),
              amount: (Number.isFinite(amountNum) && amountNum > 0 ? `${formatNumber(amountNum)} ${currency}` : '')
            };
          }) : [];

          const nextState = { ...state, rowsData: fixedRows };
          setInvoiceState(nextState);
          alert('تم تحميل الفاتورة ويمكنك تعديلها الآن.');
        } catch (err) {
          console.error(err);
          alert('ملف JSON غير صالح.');
        }
      };
      reader.readAsText(file, 'utf-8');
    }

    // ====== تحديث الفاتورة عند تغيير الهيدر ======
    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'statusInput') {
        if (!invoiceNo) return;
        buildPaginatedInvoice(rowsPerPageCurrent);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      ['dateInput', 'companyInput', 'currencyInput', 'statusInput'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', () => {
            if (invoiceNo) buildPaginatedInvoice(rowsPerPageCurrent);
          });
        }
      });
    });

    // ====== تحكم الكيبورد: Enter/Backspace ======
   document.addEventListener('keydown', (e) => {
  const tag = (e.target?.tagName || '').toLowerCase();
  const isTyping = tag === 'input' || tag === 'textarea' || e.target?.isContentEditable;

  // --- Backspace: حذف الصفوف المحددة (إذا مو داخل كتابة ولا تعديل) ---
  if (e.key === 'Backspace') {
    if (isTyping || editRowIndex !== null) return;
    if (selectedRowIndexes && selectedRowIndexes.length > 0) {
      e.preventDefault();
      deleteSelectedRow();
    }
    return;
  }

  // --- Enter: فتح التعديل أو حفظه ---
  if (e.key === 'Enter') {
    // Shift+Enter داخل الوصف = سطر جديد
    if (e.target && e.target.id === 'editDesc' && e.shiftKey) return;

    e.preventDefault();

    if (editRowIndex === null) {
      if (selectedRowIndexes && selectedRowIndexes.length === 1) {
        startEditRow();
      }
    } else {
      saveEditRow(editRowIndex);
    }
    return;
  }

  // --- Arrow Up/Down: تنقل + Shift لتوسيع/تقليص التحديد ---
  if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
    if (isTyping || editRowIndex !== null) return;

    e.preventDefault();

    // احسب عدد الصفوف الفعلي
    const totalRows = rowsData.length;
    if (totalRows === 0) return;

    // لو ماكو أنكور، خليها على أول محدد أو 0
    if (anchorIndex === null) {
      if (selectedRowIndexes.length > 0) {
        anchorIndex = selectedRowIndexes[0];
      } else {
        anchorIndex = 0;
      }
    }

    // حدّد موضع التركيز الحالي
    if (selectedRowIndexes.length > 0) {
      // خليه آخر واحد محدد (أو أي منطق يناسبك)
      focusedIndex = selectedRowIndexes[selectedRowIndexes.length - 1];
    }

    // حدّث الـ focusedIndex
    if (e.key === 'ArrowDown') {
      focusedIndex = Math.min(totalRows - 1, focusedIndex + 1);
    } else if (e.key === 'ArrowUp') {
      focusedIndex = Math.max(0, focusedIndex - 1);
    }

    if (e.shiftKey) {
      // موسّع بالرّينج من anchorIndex إلى focusedIndex
      const start = Math.min(anchorIndex, focusedIndex);
      const end   = Math.max(anchorIndex, focusedIndex);
      selectedRowIndexes = [];
      for (let i = start; i <= end; i++) selectedRowIndexes.push(i);
    } else {
      // تحديد مفرد والتنقل
      selectedRowIndexes = [focusedIndex];
      anchorIndex = focusedIndex;
    }

    buildPaginatedInvoice(rowsPerPageCurrent);
  }
});


  </script>
</body>
</html>
